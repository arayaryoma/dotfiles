#!/usr/bin/env bash

set -euo pipefail

SOURCE_DIR="${HOME}/dotfiles/.agents/skills"
TARGET_DIRS=()
USE_DEFAULT_TARGETS=1
DRY_RUN=0

usage() {
  cat <<'EOF'
Usage:
  sync-agent-skills [--source <dir>] [--target <dir>]... [--dry-run]

Default:
  --source "$HOME/dotfiles/.agents/skills"
  --target "$HOME/.codex/skills"
  --target "$HOME/.claude/skills"

Behavior:
  For each target and each entry in source, ensure target/<name> is a symlink
  to source/<name>. Existing target entries with the same name are replaced.
  When --target is specified, default targets are replaced by the provided ones.
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --source)
      SOURCE_DIR="$2"
      shift 2
      ;;
    --target)
      if [[ $# -lt 2 ]]; then
        echo "--target requires a value" >&2
        usage >&2
        exit 1
      fi
      USE_DEFAULT_TARGETS=0
      TARGET_DIRS+=("$2")
      shift 2
      ;;
    --dry-run)
      DRY_RUN=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage >&2
      exit 1
      ;;
  esac
done

if [[ "$USE_DEFAULT_TARGETS" -eq 1 ]]; then
  TARGET_DIRS=("${HOME}/.codex/skills" "${HOME}/.claude/skills")
fi

if [[ ! -d "$SOURCE_DIR" ]]; then
  echo "Source directory not found: $SOURCE_DIR" >&2
  exit 1
fi

shopt -s nullglob dotglob

for target_dir in "${TARGET_DIRS[@]}"; do
  mkdir -p "$target_dir"
  for src in "$SOURCE_DIR"/*; do
    name="$(basename "$src")"
    dst="$target_dir/$name"

    if [[ -L "$dst" ]] && [[ "$(readlink "$dst")" == "$src" ]]; then
      echo "skip: $dst -> $src"
      continue
    fi

    if [[ "$DRY_RUN" -eq 1 ]]; then
      if [[ -e "$dst" || -L "$dst" ]]; then
        echo "replace: $dst"
      fi
      echo "link: $dst -> $src"
      continue
    fi

    if [[ -e "$dst" || -L "$dst" ]]; then
      rm -rf "$dst"
    fi

    ln -s "$src" "$dst"
    echo "linked: $dst -> $src"
  done
done
